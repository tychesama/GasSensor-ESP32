<!DOCTYPE html>
<html>

<head>
    <title>Real-Time Sensors</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>

    <style>
        body {
            font-family: Arial;
            background: #f4f6f8;
            text-align: center;
        }

        canvas {
            background: white;
            width: 50vw;
            height: 400px;
            margin: 30px auto;
            display: block;
        }

        #status {
            font-size: 20px;
            font-weight: bold;
            margin: 10px;
        }
    </style>
</head>

<body>

    <h2>Real-Time Sensor Monitoring</h2>
    <div id="status">Temperature Status: --</div>

    <canvas id="tempChart"></canvas>
    <canvas id="humChart"></canvas>
    <canvas id="gasChart"></canvas>

    <script>
        function tempStatus(t) {
            if (t >= 50) return ["EXTREME DANGER", "red"];
            if (t >= 42) return ["DANGER", "orange"];
            if (t >= 33) return ["CAUTION", "gold"];
            if (t >= 27) return ["OK", "green"];
            return ["NORMAL", "green"];
        }

        const backgroundZones = {
            id: 'backgroundZones',
            beforeDraw(chart) {
                if (chart.canvas.id !== "tempChart") return;

                const { ctx, chartArea, scales } = chart;
                if (!chartArea) return;

                const y = scales.y;
                const zones = [
                    { from: 50, to: y.max, color: 'rgba(255,0,0,0.2)' },
                    { from: 42, to: 50, color: 'rgba(255,165,0,0.2)' },
                    { from: 33, to: 42, color: 'rgba(255,255,0,0.25)' },
                    { from: 27, to: 33, color: 'rgba(144,238,144,0.3)' }
                ];

                zones.forEach(z => {
                    ctx.fillStyle = z.color;
                    ctx.fillRect(
                        chartArea.left,
                        y.getPixelForValue(z.from),
                        chartArea.right - chartArea.left,
                        y.getPixelForValue(z.to) - y.getPixelForValue(z.from)
                    );
                });
            }
        };

        function createChart(canvasId, label, yMax) {
            return new Chart(document.getElementById(canvasId), {
                type: 'line',
                data: {
                    datasets: [{
                        label,
                        borderWidth: 2,
                        pointRadius: 0,
                        data: []
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'realtime',
                            realtime: {
                                duration: 100000,
                                refresh: 1000,
                                delay: 2000,
                                onRefresh: chart => {
                                    fetch('/data')
                                        .then(r => r.json())
                                        .then(d => {
                                            const now = Date.now();

                                            if (canvasId === "tempChart") {
                                                chart.data.datasets[0].data.push({ x: now, y: d.temp });
                                                const [text, color] = tempStatus(d.temp);
                                                document.getElementById("status").textContent = "Status: " + text;
                                                document.getElementById("status").style.color = color;
                                            }

                                            if (canvasId === "humChart")
                                                chart.data.datasets[0].data.push({ x: now, y: d.hum });

                                            if (canvasId === "gasChart")
                                                chart.data.datasets[0].data.push({ x: now, y: d.gas });
                                        });
                                }
                            }
                        },
                        y: {
                            min: 0,
                            max: yMax,
                            title: { display: true, text: label }
                        }
                    }
                }
            });
        }

        createChart("tempChart", "Temperature (Â°C)", 100);
        createChart("humChart", "Humidity (%)", 100);
        createChart("gasChart", "Gas Level", 1000);

        Chart.register(backgroundZones);
    </script>

</body>

</html>